<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Панель керівника – Відгуки</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin:0; 
      padding:20px; 
      background:#f5f5f5; 
    }
    .card { 
      background:white; 
      border-radius:12px; 
      padding:20px; 
      box-shadow:0 4px 15px rgba(0,0,0,0.1); 
      margin-bottom:20px; 
    }
    table { 
      width:100%; 
      border-collapse:collapse; 
    }
    th, td { 
      padding:12px; 
      text-align:left; 
      border-bottom:1px solid #ddd; 
    }
    th { 
      background:#007bff; 
      color:white; 
    }
    .stats { 
      display:grid; 
      grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); 
      gap:15px; 
      margin:20px 0; 
    }
    .stat-card { 
      background:#007bff; 
      color:white; 
      padding:20px; 
      border-radius:10px; 
      text-align:center; 
      font-size:18px; 
    }
    h1 { 
      text-align:center; 
      color:#333; 
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .refresh-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px auto;
      display: block;
    }
    .refresh-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <h1>Відгуки клієнтів</h1>
  <button class="refresh-btn" onclick="loadData()">Оновити дані</button>
  <div id="error-container"></div>
  <div class="stats" id="stats"></div>
  <div class="card">
    <canvas id="ratingChart"></canvas>
  </div>
  <div class="card">
    <table id="table"></table>
  </div>

<script>
let chartInstance = null;

async function loadData() {
  const errorContainer = document.getElementById('error-container');
  errorContainer.innerHTML = '<div class="loading">Завантаження даних...</div>';
  
  try {
    const res = await fetch('/api/feedback');
    
    if (!res.ok) {
      throw new Error('Помилка завантаження даних: ' + res.status);
    }
    
    const data = await res.json();
    errorContainer.innerHTML = '';

    // Таблиця
    const table = document.getElementById('table');
    table.innerHTML = `<tr><th>Працівник</th><th>Оцінка</th><th>Коментар</th><th>Час</th></tr>`;
    
    if (data.length === 0) {
      const tr = table.insertRow();
      tr.innerHTML = '<td colspan="4" style="text-align:center; color:#999;">Відгуків поки немає</td>';
    } else {
      data.forEach(f => {
        const tr = table.insertRow();
        tr.innerHTML = `<td>${f.employeeId || 'невідомо'}</td>
                        <td>${'★'.repeat(f.rating)}${'☆'.repeat(5-f.rating)}</td>
                        <td>${f.comment || '—'}</td>
                        <td>${new Date(f.timestamp).toLocaleString('uk-UA')}</td>`;
      });
    }

    // Статистика
    const total = data.length;
    const avg = total > 0 ? data.reduce((a,b)=>a+b.rating,0)/total : 0;
    const today = data.filter(d=>new Date(d.timestamp).toDateString()===new Date().toDateString()).length;
    
    document.getElementById('stats').innerHTML = `
      <div class="stat-card">Всього відгуків<br><b>${total}</b></div>
      <div class="stat-card">Середня оцінка<br><b>${avg.toFixed(1)} ★</b></div>
      <div class="stat-card">Сьогодні<br><b>${today}</b></div>
    `;

    // Графік
    const ctx = document.getElementById('ratingChart').getContext('2d');
    const counts = [0,0,0,0,0];
    data.forEach(f => counts[f.rating-1]++);
    
    // Видалити старий графік, якщо є
    if (chartInstance) {
      chartInstance.destroy();
    }
    
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels: ['1★','2★','3★','4★','5★'], 
        datasets: [{ 
          label: 'Кількість', 
          data: counts, 
          backgroundColor: '#007bff' 
        }] 
      },
      options: { 
        responsive: true, 
        scales: { 
          y: { 
            beginAtZero: true, 
            ticks: { stepSize: 1 } 
          } 
        } 
      }
    });
  } catch (err) {
    console.error('Помилка:', err);
    errorContainer.innerHTML = `<div class="error">
      Помилка завантаження: ${err.message}<br>
      <small>Перевірте підключення до інтернету та налаштування API</small>
    </div>`;
  }
}

// Завантажити дані при завантаженні сторінки
loadData();

// Оновлення кожні 30 секунд
setInterval(loadData, 30000);
</script>
</body>
</html>